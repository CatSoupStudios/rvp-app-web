---
// src/components/Reviews.astro

// DATOS REALISTAS (Mix de fotos y placeholders, estrellas variadas)
const reviews = [
  {
    name: "Sarah Jenkins",
    loc: "Bakersfield, CA",
    text: "Cleanest contractors I've ever hired. The lines are razor sharp.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/women/44.jpg",
  },
  {
    name: "Mike R.",
    loc: "Seven Oaks",
    text: "Quality is top-notch, but the scheduling took a bit longer than expected.",
    stars: 4,
    img: null,
  },
  {
    name: "Elena Rodriguez",
    loc: "Tehachapi, CA",
    text: "They finished 2 days ahead of schedule despite the wind. Amazing team.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/women/68.jpg",
  },
  {
    name: "David Chen",
    loc: "Bakersfield, CA",
    text: "Great communication and the matte finish is stunning.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/men/32.jpg",
  },
  {
    name: "Jessica Alva",
    loc: "California City",
    text: "A luxury experience. They protected all my furniture perfectly.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/women/90.jpg",
  },
  {
    name: "Robert Fox",
    loc: "Stockdale",
    text: "High-end quality. Recommended to neighbors in Seven Oaks.",
    stars: 5,
    img: null,
  },
  {
    name: "Amanda Low",
    loc: "Tehachapi, CA",
    text: "The paint job is solid, though they left a small mess in the yard.",
    stars: 3,
    img: "https://randomuser.me/api/portraits/women/22.jpg",
  },
  {
    name: "Tom H.",
    loc: "Bakersfield, CA",
    text: "Honest pricing and superior workmanship. No complaints.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/men/46.jpg",
  },
];

// Segunda fila de datos
const reviewsRow2 = [
  {
    name: "Patricia Wu",
    loc: "Bakersfield, CA",
    text: "Finally a painter who pays attention to detail! Very happy.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/women/33.jpg",
  },
  {
    name: "Greg Norman",
    loc: "California City",
    text: "Solid work. Would hire again for the exterior.",
    stars: 4,
    img: null,
  },
  {
    name: "Sophie T.",
    loc: "Bakersfield, CA",
    text: "My living room looks like a magazine cover. Thank you!",
    stars: 5,
    img: "https://randomuser.me/api/portraits/women/12.jpg",
  },
  {
    name: "Alex M.",
    loc: "Tehachapi, CA",
    text: "Very respectful of our home and pets. Great paint job.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/men/22.jpg",
  },
  {
    name: "Linda K.",
    loc: "Bakersfield, CA",
    text: "Good execution, but communication was slow during the quote process.",
    stars: 3,
    img: null,
  },
  {
    name: "James V.",
    loc: "Bakersfield, CA",
    text: "Efficient team. The commercial lobby looks brand new.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/men/18.jpg",
  },
  {
    name: "Diana Prince",
    loc: "Tehachapi, CA",
    text: "Best painters in Kern County. Hands down.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/women/65.jpg",
  },
  {
    name: "Kevin Hart",
    loc: "Bakersfield, CA",
    text: "Exceptional service from the quote to the final walkthrough.",
    stars: 5,
    img: "https://randomuser.me/api/portraits/men/91.jpg",
  },
];

// SEO: Schema Markup para "AggregateRating" (Estrellas en Google)
const schemaReviews = {
  "@context": "https://schema.org",
  "@type": "LocalBusiness",
  name: "Rangel Valley Painting",
  aggregateRating: {
    "@type": "AggregateRating",
    ratingValue: "4.8", // Calculado o hardcoded basado en tus reviews reales
    reviewCount: "16", // Total de reviews mostradas
  },
};
---

<section
  id="reviews"
  class="py-24 bg-[var(--brand-bg)] overflow-hidden relative cursor-default"
>
  <div
    class="max-w-7xl mx-auto px-6 mb-16 text-center relative z-10 pointer-events-none"
  >
    <div
      class="inline-flex items-center gap-2 py-1.5 px-4 rounded-full border border-[var(--brand-accent)]/30 bg-[var(--brand-accent)]/5 text-[var(--brand-primary)] text-[10px] font-bold tracking-[0.2em] uppercase mb-6"
    >
      <span
        class="w-1.5 h-1.5 rounded-full bg-[var(--brand-accent)] animate-pulse"
      ></span>
      Verified Client Reviews
    </div>
    <h2
      class="text-4xl md:text-6xl font-serif font-medium text-[var(--brand-primary)] tracking-tight"
    >
      Loved by locals.
    </h2>
  </div>

  <div
    class="absolute left-0 top-0 bottom-0 w-16 md:w-32 bg-gradient-to-r from-[var(--brand-bg)] to-transparent z-20 pointer-events-none"
  >
  </div>
  <div
    class="absolute right-0 top-0 bottom-0 w-16 md:w-32 bg-gradient-to-l from-[var(--brand-bg)] to-transparent z-20 pointer-events-none"
  >
  </div>

  <div class="marquee-container mb-8" data-speed="0.5" data-direction="-1">
    <div class="marquee-track">
      {
        [...reviews, ...reviews, ...reviews].map((review) => (
          <div class="review-card">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-10 h-10 rounded-full bg-[var(--color-bone)] border border-[var(--brand-border)] overflow-hidden flex-shrink-0">
                {review.img ? (
                  <img
                    src={review.img}
                    alt={review.name}
                    class="w-full h-full object-cover"
                    draggable="false"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center bg-[var(--brand-primary)] text-[#EAE0D5] font-serif font-bold">
                    {review.name.charAt(0)}
                  </div>
                )}
              </div>
              <div>
                <h4 class="font-serif font-bold text-[var(--brand-primary)] text-sm leading-tight">
                  {review.name}
                </h4>
                <p class="text-[10px] text-[var(--brand-accent)] font-bold uppercase tracking-wider mt-0.5 opacity-80">
                  {review.loc}
                </p>
              </div>
            </div>
            <div class="flex gap-1 mb-3">
              {[...Array(5)].map((_, i) => (
                <svg
                  class={`w-3 h-3 ${i < review.stars ? "text-[var(--brand-accent)]" : "text-gray-200"}`}
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              ))}
            </div>
            <p class="text-[var(--brand-text-muted)] text-sm leading-relaxed font-light italic select-none">
              "{review.text}"
            </p>
          </div>
        ))
      }
    </div>
  </div>

  <div class="marquee-container" data-speed="0.5" data-direction="1">
    <div class="marquee-track">
      {
        [...reviewsRow2, ...reviewsRow2, ...reviewsRow2].map((review) => (
          <div class="review-card">
            <div class="flex items-center gap-4 mb-4">
              <div class="w-10 h-10 rounded-full bg-[var(--color-bone)] border border-[var(--brand-border)] overflow-hidden flex-shrink-0">
                {review.img ? (
                  <img
                    src={review.img}
                    alt={review.name}
                    class="w-full h-full object-cover"
                    draggable="false"
                  />
                ) : (
                  <div class="w-full h-full flex items-center justify-center bg-[var(--brand-primary)] text-[#EAE0D5] font-serif font-bold">
                    {review.name.charAt(0)}
                  </div>
                )}
              </div>
              <div>
                <h4 class="font-serif font-bold text-[var(--brand-primary)] text-sm leading-tight">
                  {review.name}
                </h4>
                <p class="text-[10px] text-[var(--brand-accent)] font-bold uppercase tracking-wider mt-0.5 opacity-80">
                  {review.loc}
                </p>
              </div>
            </div>
            <div class="flex gap-1 mb-3">
              {[...Array(5)].map((_, i) => (
                <svg
                  class={`w-3 h-3 ${i < review.stars ? "text-[var(--brand-accent)]" : "text-gray-200"}`}
                  fill="currentColor"
                  viewBox="0 0 20 20"
                >
                  <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                </svg>
              ))}
            </div>
            <p class="text-[var(--brand-text-muted)] text-sm leading-relaxed font-light italic select-none">
              "{review.text}"
            </p>
          </div>
        ))
      }
    </div>
  </div>
</section>

<!-- SEO: Script JSON-LD Inyectado -->
<script type="application/ld+json" set:html={JSON.stringify(schemaReviews)} />

<style>
  /* Estilos Base de las Tarjetas */
  .marquee-container {
    width: 100%;
    overflow: hidden;
    cursor: grab;
    touch-action: none;
    padding-top: 2rem; /* Espacio para que la sombra no se corte arriba */
    padding-bottom: 2rem; /* Espacio para que la sombra no se corte abajo */
  }

  .marquee-container:active {
    cursor: grabbing;
  }

  .marquee-track {
    display: flex;
    gap: 1.5rem;
    width: max-content;
    will-change: transform;
  }

  .review-card {
    width: 300px;
    padding: 1.5rem;
    background: white;

    /* === CAMBIOS AQUÍ: ADIÓS BORDE, HOLA SOMBRA === */
    border: none; /* Quitamos el borde sólido */
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.03); /* Sombra muy sutil por defecto */

    border-radius: 1.5rem; /* Un poco más redondeado para que se vea más suave */
    flex-shrink: 0;
    transition:
      transform 0.3s ease,
      box-shadow 0.3s ease;
    user-select: none;
  }

  .review-card:hover {
    /* Al pasar el mouse, sube y aumenta la sombra */
    transform: translateY(-5px);
    box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.08);
  }

  @media (max-width: 768px) {
    .review-card {
      width: 260px;
      padding: 1.2rem;
    }
  }
</style>

<script>
  // Lógica de Movimiento Fluido + Drag & Drop
  document.addEventListener("DOMContentLoaded", () => {
    class InteractiveMarquee {
      el: HTMLElement;
      track: HTMLElement | null;
      baseSpeed: number;
      direction: number;
      x: number;
      isDragging: boolean;
      startX: number;
      lastX: number;
      trackWidth: number;
      loopThreshold: number;

      constructor(el: HTMLElement) {
        this.el = el;
        this.track = el.querySelector(".marquee-track");

        // Configuración
        this.baseSpeed = parseFloat(el.dataset.speed || "0.5");
        this.direction = parseFloat(el.dataset.direction || "-1"); // -1 izq, 1 der

        // Estado
        this.x = 0;
        this.isDragging = false;
        this.startX = 0;
        this.lastX = 0;

        // Dimensiones para el loop infinito
        // Importante: Asumimos que triplicamos el contenido, el loop ocurre al 33.33%
        this.trackWidth = 0;
        this.loopThreshold = 0;

        // Bindings
        this.animate = this.animate.bind(this);
        this.handleStart = this.handleStart.bind(this);
        this.handleMove = this.handleMove.bind(this);
        this.handleEnd = this.handleEnd.bind(this);
        this.calculateDimensions = this.calculateDimensions.bind(this);

        this.init();
      }

      init() {
        this.calculateDimensions();
        window.addEventListener("resize", this.calculateDimensions);

        // Eventos de Mouse y Touch unificados
        this.el.addEventListener("pointerdown", this.handleStart);
        window.addEventListener("pointermove", this.handleMove);
        window.addEventListener("pointerup", this.handleEnd);
        window.addEventListener("pointercancel", this.handleEnd);

        // Iniciar animación
        requestAnimationFrame(this.animate);
      }

      calculateDimensions() {
        if (this.track) {
          this.trackWidth = this.track.offsetWidth;
          // El punto de loop es un tercio del ancho total (porque renderizamos 3 sets)
          this.loopThreshold = this.trackWidth / 3;
        }
      }

      handleStart(e: PointerEvent) {
        this.isDragging = true;
        this.startX = e.clientX;
        this.lastX = this.x;
        // Pausar cursor CSS
        this.el.style.cursor = "grabbing";
      }

      handleMove(e: PointerEvent) {
        if (!this.isDragging) return;

        const currentX = e.clientX;
        const diff = currentX - this.startX;

        // Mover con el dedo/mouse (multiplicador 1.5 para sensación más ágil)
        this.x = this.lastX + diff * 1.5;
      }

      handleEnd() {
        this.isDragging = false;
        this.el.style.cursor = "grab";
      }

      animate() {
        // Si NO estamos arrastrando, aplicamos la velocidad automática
        if (!this.isDragging) {
          this.x += this.baseSpeed * this.direction;
        }

        // Lógica de Loop Infinito
        // Si nos pasamos hacia la izquierda
        if (this.x <= -this.loopThreshold) {
          // Resetear sumando el ancho del bloque
          this.x += this.loopThreshold;
        }
        // Si nos pasamos hacia la derecha (o inicio)
        else if (this.x > 0) {
          // Resetear restando el ancho del bloque
          this.x -= this.loopThreshold;
        }

        // Aplicar transformación
        if (this.track) {
          this.track.style.transform = `translate3d(${this.x}px, 0, 0)`;
        }

        requestAnimationFrame(this.animate);
      }
    }

    // Inicializar todos los marquees en la página
    const marquees = document.querySelectorAll(".marquee-container");
    marquees.forEach((m) => new InteractiveMarquee(m as HTMLElement));
  });
</script>
